"""Helper functions
"""

import numpy as np
import xarray as xr


def cross(a, b, spatial_dim, output_dtype=None):
    """xarray-compatible cross product
    
    Compatible with dask, parallelization uses a.dtype as output_dtype
    """
    for d in (a, b):
        if spatial_dim not in d.dims:
            raise ValueError('dimension {} not in {}'.format(spatial_dim, d))
        if d.sizes[spatial_dim] != 3:
            raise ValueError('dimension {} has not length 3 in {}'.format(d))
        
    if output_dtype is None:
        output_dtype = a.dtype
    
    try:
        c = xr.apply_ufunc(np.cross, a, b,
                        input_core_dims=[[spatial_dim], [spatial_dim]], 
                        output_core_dims=[[spatial_dim]], 
                        dask='parallelized', output_dtypes=[output_dtype]
                          )
    except: 
        print(a)
        print(b)
        raise
    
    return c
